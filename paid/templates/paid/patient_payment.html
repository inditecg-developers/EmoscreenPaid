{% extends "content/base.html" %}
{% block content %}
<h2>Payment</h2>
<div class="card">
  <p><strong>Amount:</strong> â‚¹{{ final_amount_rupees|floatformat:2 }}</p>
  {% if payment_error %}
    <p style="color:#b91c1c"><strong>{{ payment_error }}</strong></p>
  {% endif %}

  <form id="payment-result-form" method="post" style="display:none">
    {% csrf_token %}
    <input type="hidden" name="razorpay_payment_id" id="razorpay_payment_id">
    <input type="hidden" name="razorpay_order_id" id="razorpay_order_id">
    <input type="hidden" name="razorpay_signature" id="razorpay_signature">
  </form>

  <button class="btn btn-green" id="pay-now" type="button">Pay Now</button>
  <p class="muted" style="margin-top:8px">Secure checkout powered by Razorpay.</p>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  (function () {
    const btn = document.getElementById("pay-now");
    const resultForm = document.getElementById("payment-result-form");
    if (!btn || !window.Razorpay || !resultForm) return;

    btn.addEventListener("click", function () {
      const options = {
        key: "{{ razorpay_key_id|escapejs }}",
        amount: "{{ order.final_amount_paise }}",
        currency: "INR",
        name: "EmoScreen",
        description: "EmoScreen Assessment",
        order_id: "{{ gateway_order_id|escapejs }}",
        prefill: {
          name: "{{ order.patient_name|default:''|escapejs }}",
          email: "{{ order.patient_email|default:''|escapejs }}",
          contact: "{{ order.patient_whatsapp|default:''|escapejs }}"
        },
        notes: {
          order_code: "{{ order.order_code|escapejs }}"
        },
        theme: { color: "#2f855a" },
        handler: function (response) {
          document.getElementById("razorpay_payment_id").value = response.razorpay_payment_id || "";
          document.getElementById("razorpay_order_id").value = response.razorpay_order_id || "";
          document.getElementById("razorpay_signature").value = response.razorpay_signature || "";
          resultForm.submit();
        },
        modal: {
          ondismiss: function () {
            console.log("Payment popup closed");
          }
        }
      };

      const rzp = new Razorpay(options);
      rzp.on("payment.failed", function () {
        alert("Payment failed. Please retry.");
      });
      rzp.open();
    });
  })();
</script>
{% endblock %}
